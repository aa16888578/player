<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube æ’­æ”¾å™¨ - ç°¡æ½”ç‰ˆ</title>
<style>
  /* Resetèˆ‡åŸºæœ¬æ’ç‰ˆ */E html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YouTube æ’­æ”¾å™¨ - ç°¡æ½”ç‰ˆ</title>
<style>
  /* Resetèˆ‡åŸºæœ¬æ’ç‰ˆ */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    height: 100%;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
  }
  #container {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* å½±ç‰‡æ’­æ”¾å™¨å ç”¨ä¸»è¦å€åŸŸ */
  #player-wrapper {
    flex: 1;
    position: relative;
  }
  iframe#ytplayer {
    width: 100%;
    height: 100%;
    border: none;
    background: #000;
  }

  /* æ’­æ”¾å™¨æ§åˆ¶å€ */
  #player-controls {
    background: rgba(0, 0, 0, 0.7);
    padding: 10px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  #player-wrapper:hover #player-controls {
    opacity: 1;
  }
  .control-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.2s;
  }
  .control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  /* è¼‰å…¥æç¤º */
  #loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 1.2em;
  }
  
  /* æ¨è–¦å½±ç‰‡å€å¡Š */
  #recommend-area {
    background: #111;
    padding: 8px 12px;
    display: flex;
    gap: 10px;
    overflow-x: auto;
    border-top: 1px solid #333;
    scrollbar-width: thin;
    scrollbar-color: #666 #111;
  }
  #recommend-area::-webkit-scrollbar {
    height: 8px;
  }
  #recommend-area::-webkit-scrollbar-track {
    background: #111;
  }
  #recommend-area::-webkit-scrollbar-thumb {
    background-color: #666;
    border-radius: 4px;
  }

  /* æ¨è–¦å½±ç‰‡é …ç›® */
  .rec-item {
    flex: 0 0 auto;
    width: 140px;
    cursor: pointer;
    text-align: center;
    user-select: none;
  }
  .rec-item img {
    width: 100%;
    border-radius: 8px;
    transition: transform 0.2s ease;
  }
  .rec-item:hover img {
    transform: scale(1.05);
  }
  .rec-title {
    margin-top: 6px;
    font-size: 0.9em;
    color: #eee;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
</head>
<body>
  <div id="container">
    <div id="player-wrapper">
      <iframe id="ytplayer" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
      <div id="loading-overlay">è¼‰å…¥ä¸­...</div>
      <div id="player-controls">
        <button class="control-btn" id="prev-btn" title="ä¸Šä¸€å€‹">â®</button>
        <button class="control-btn" id="replay-btn" title="é‡æ’­">ğŸ”„</button>
        <button class="control-btn" id="next-btn" title="ä¸‹ä¸€å€‹">â­</button>
      </div>
    </div>
    <div id="recommend-area">
      <!-- å½±ç‰‡æ¨è–¦å°‡ç”± JS æ³¨å…¥ -->
    </div>
    <div id="error-message" style="display:none; background: #ff4444; color: white; padding: 10px; text-align: center;"></div>
  </div>

  <script>
    // è®€å–ç¶²å€åƒæ•¸å’Œæœ¬åœ°å­˜å„²
    const params = new URLSearchParams(window.location.search);
    let currentVideoId = params.get("video_id");
    let currentVideoIndex = 0;

    // å¾æœ¬åœ°å­˜å„²è®€å–æ’­æ”¾æ­·å²
    const playHistory = JSON.parse(localStorage.getItem('ytPlayerHistory') || '[]');
    
    // æ¨è–¦å½±ç‰‡åˆ—è¡¨ï¼šè‡ªè¡Œæ›¿æ›ç‚ºä½ æƒ³æ¨è–¦çš„å½±ç‰‡IDå’Œæ¨™é¡Œ
    const recommendedVideos = [
      { id: "QKb30DgwZ7Y", title: "ç†±é–€æ¨è–¦å½±ç‰‡1", views: 0 },
      { id: "60ItHLz5WEA", title: "ç†±é–€æ¨è–¦å½±ç‰‡2", views: 0 },
      { id: "G9j7OObRiRQ", title: "ç²¾é¸ç†±é–€å½±ç‰‡3", views: 0 },
      { id: "oBbc_XWlgoE", title: "ç²¾å½©éŸ³æ¨‚4", views: 0 },
      { id: "2Vv-BfVoq4g", title: "æµè¡Œæ­Œæ›²5", views: 0 }
    ].map(video => {
      // å¾æœ¬åœ°å­˜å„²è®€å–è§€çœ‹æ¬¡æ•¸
      const historyItem = playHistory.find(h => h.id === video.id);
      return { ...video, views: historyItem ? historyItem.views : 0 };
    });

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    // å½±ç‰‡IDæœ‰æ•ˆæ€§ç°¡æ˜“é©—è­‰
    function validVideoId(id) {
      return id && /^[\w-]{11}$/.test(id);
    }

    // è¨­å®šæ’­æ”¾å™¨ src
    function loadVideo(id, updateUrl = true) {
      if (!validVideoId(id)) {
        showError("ç„¡æ•ˆçš„å½±ç‰‡ID");
        return;
      }

      const loadingOverlay = document.getElementById('loading-overlay');
      loadingOverlay.style.display = 'flex';

      const player = document.getElementById("ytplayer");
      currentVideoId = id;
      
      // æ›´æ–° URL
      if (updateUrl) {
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('video_id', id);
        window.history.pushState({}, '', newUrl);
      }

      // æ›´æ–°æ’­æ”¾æ­·å²
      const historyIndex = playHistory.findIndex(h => h.id === id);
      if (historyIndex > -1) {
        playHistory[historyIndex].views++;
        playHistory[historyIndex].lastPlayed = Date.now();
      } else {
        playHistory.push({ id, views: 1, lastPlayed: Date.now() });
      }
      localStorage.setItem('ytPlayerHistory', JSON.stringify(playHistory));

      // æ›´æ–°ç•¶å‰ç´¢å¼•
      currentVideoIndex = recommendedVideos.findIndex(v => v.id === id);
      
      // ä½¿ç”¨ autoplay=1ï¼Œè‡ªå‹•æ’­æ”¾
      player.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0&modestbranding=1&showinfo=0&iv_load_policy=3`;
      
      // ç›£è½ iframe è¼‰å…¥å®Œæˆ
      player.onload = () => {
        loadingOverlay.style.display = 'none';
      };
    }

    // æ’­æ”¾æ§åˆ¶åŠŸèƒ½
    function playNext() {
      const nextIndex = (currentVideoIndex + 1) % recommendedVideos.length;
      loadVideo(recommendedVideos[nextIndex].id);
    }

    function playPrevious() {
      const prevIndex = (currentVideoIndex - 1 + recommendedVideos.length) % recommendedVideos.length;
      loadVideo(recommendedVideos[prevIndex].id);
    }

    function replayVideo() {
      loadVideo(currentVideoId, false);
    }

    // å»ºç«‹æ¨è–¦å½±ç‰‡å€ DOM
    function buildRecommendation() {
      const area = document.getElementById("recommend-area");
      area.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
      
      // ä¾æ“šè§€çœ‹æ¬¡æ•¸æ’åºæ¨è–¦
      const sortedVideos = [...recommendedVideos].sort((a, b) => b.views - a.views);
      
      sortedVideos.forEach(video => {
        const item = document.createElement("div");
        item.className = "rec-item";
        item.title = `${video.title} (è§€çœ‹æ¬¡æ•¸: ${video.views})`;
        item.innerHTML = `
        <img src="https://i.ytimg.com/vi/${video.id}/hqdefault.jpg" alt="${video.title}" />
        <div class="rec-title">${video.title}</div>
        `;
        item.addEventListener("click", () => {
          if(video.id !== currentVideoId) {
            loadVideo(video.id);
          }
        });
        area.appendChild(item);
      });
    }

    // è¨­ç½®æ’­æ”¾æ§åˆ¶æŒ‰éˆ•äº‹ä»¶
    document.getElementById('prev-btn').addEventListener('click', playPrevious);
    document.getElementById('next-btn').addEventListener('click', playNext);
    document.getElementById('replay-btn').addEventListener('click', replayVideo);

    // éµç›¤æ§åˆ¶
    document.addEventListener('keydown', (e) => {
      switch(e.key) {
        case 'ArrowLeft':
          playPrevious();
          break;
        case 'ArrowRight':
          playNext();
          break;
        case 'r':
        case 'R':
          replayVideo();
          break;
      }
    });

    // åˆå§‹è¼‰å…¥å½±ç‰‡èˆ‡æ¨è–¦åˆ—è¡¨
    if(validVideoId(currentVideoId)) {
      loadVideo(currentVideoId);
    } else {
      // è‹¥ç¶²å€ç„¡video_idï¼Œå‰‡è‡ªå‹•æ”¾ç¬¬ä¸€æ”¯æ¨è–¦å½±ç‰‡
      loadVideo(recommendedVideos[0].id);
    }
    buildRecommendation();
    // åˆå§‹è¼‰å…¥å½±ç‰‡èˆ‡æ¨è–¦åˆ—è¡¨
    if(validVideoId(currentVideoId)) {
      loadVideo(currentVideoId);
    } else {
      // è‹¥ç¶²å€ç„¡video_idï¼Œå‰‡è‡ªå‹•æ”¾ç¬¬ä¸€æ”¯æ¨è–¦å½±ç‰‡
      loadVideo(recommendedVideos[0].id);
    }
    buildRecommendation();
  </script>
</body>
</html>
